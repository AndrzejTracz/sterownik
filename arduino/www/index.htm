<!doctype html>
<html lang="en" ng-app="app">
	<head>
		<link rel="stylesheet" href="b.css" />
		<link rel="stylesheet" href="http://cdn.jsdelivr.net/jqplot/1.0.2/jquery.jqplot.min.css" />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.1/angular.min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/flot/0.7/jquery.flot.min.js"></script>
		<script type="text/ng-template" id="dash.tpl.html">
			<div class="row-fluid">
				<div class="span3 well">
					<h2>Status sterownika:</h2>
					<table class="table">
						<tr>
							<td>Polaczenie:</td>
							<td>
								<span ng-show="aok">
									<i class="icon-thumbs-up icon-white"></i> <span class="label label-success">ONLINE</span>
								</span>
								<span ng-show="!aok">
									<i class="icon-thumbs-down icon-white"></i> <span class="label label-important">OFFLINE</span>
								</span>
							</td>
						</tr>
						<tr>
							<td>Uptime</td> 
							<td><i class="icon-time icon-white"></i> {{uptime}} s.</td>
						</tr>
						<tr>
							<td>Pompa CWU1</td> 
							<td>
								<span ng-show="pump.cwu1 == 'OFF'" class="label label-important"> {{pump.cwu1}}</span>
								<span ng-show="pump.cwu1 == 'ON'" class="label label-success"> {{pump.cwu1}}</span>
							</td>
                                                </tr>
                                                <tr>
                                                        <td>Pompa CWU2</td> 
                                                        <td>
                                                                <span ng-show="pump.cwu2 == 'OFF'" class="label label-important"> {{pump.cwu2}}</span>
                                                                <span ng-show="pump.cwu2 == 'ON'" class="label label-success"> {{pump.cwu2}}</span>
                                                        </td>
						</tr>
						<tr>
							<td>Next Update</td> 
							<td><i class="icon-calendar icon-white"></i> {{nextResponse}} s.</td>
						</tr>
					</table>
				</div>
				<div class="span2 well">
					<h2>Pomiary:</h2>
					<table class="table">
						<tr ng-repeat="thermo in thermos" ng-init="sources = ['tCO','tCWU1','tCWU2','tSpaliny','wentylator']">
							<td>{{sources[$index]}}</td> 
							<td><span class="badge badge-warning">{{thermo.temp | number:2}} &deg;C</span></td>
						</tr>
                                                         <td>Wentylator</td> 
                                                        <td><span class="badge badge-warning">{{thermos[4].temp | number}} %</span></td>
					</table>
					</div>
				<div class="span4 well">
					<h2>Konfiguracja</h2>
					<table class="table">
						<tr>
							<td>Arduino IP</td> 
							<td><input type="url" class="input" placeholder="Arduino IP" ng-model="ip"></td>
						</tr>
						<tr>
							<td>Aktualizuj co:</td>
							<td>
								<div class="input-append">
									<input type="number" class="input input-small" ng-model="updateRate">
									<span class="add-on">s.</span>
								</div>
							</td>
						</tr>
						<tr>
							<td>Ilosc danych:</td>
							<td><input type="number" class="input input-small" ng-model="dataPoints"></td>
						</tr>
					</table>
				</div>
				<div class="span3 well">
					<h2>Polecenia:</h2>
					<table class="table">
					<tr><td><a ng-click="updateNow()" class="btn"><i class="icon-refresh icon-white"></i> Aktualizuj</a></td></tr>
					<tr><td>
						<div class="btn-group">
							<a ng-click="pumpOn()" class="btn"><i class="icon-play icon-white"></i> Start CWU1</a>
							<a ng-click="pumpOff()" class="btn"><i class="icon-stop icon-white"></i> Stop CWU1</a>
						</div>
					    </td>
                                        </tr>
                                        <tr><td>
                                                <div class="btn-group">
                                                        <a ng-click="pumpOn()" class="btn"><i class="icon-play icon-white"></i> Start CWU2</a>
                                                        <a ng-click="pumpOff()" class="btn"><i class="icon-stop icon-white"></i> Stop CWU2</a>
                                                </div>
                                                </td>
					</tr>
					</table>
				</div>
			</div>
		</script>
		
		<script>
			angular.module('app', []).
			  config(['$routeProvider', function($routeProvider) {
			  $routeProvider.
			      when('/', {templateUrl: 'dash.tpl.html',   controller: DashCtrl}).
			      otherwise({redirectTo: '/'});
			}]);
			
			function DashCtrl($scope){
				$scope.update = function(){
					$.get($scope.ip + "/thermos.json",function(data){
						$scope.$apply(function(){
							$scope.thermos = JSON.parse(data);
							$scope.lastResponse = new Date();
							$scope.aok = true;
						});
						now = $scope.lastResponse.getTime() - 1000*60*60*7;
						
						window.lines.forEach(function(l,i){
							l.data.push([now,$scope.thermos[i].temp]);
							if(l.data.length > $scope.dataPoints){
								l.data.shift();
							}
						});

						window.updateGraph();
						
					}).error(function() {
						$scope.$apply(function(){
							$scope.aok = false;
						});
					});
					
					$.get($scope.ip + "/pump.json",function(data){
						$scope.$apply(function(){
							$scope.pump = JSON.parse(data);
							$scope.aok = true;
						});
					});
					
					$.get($scope.ip + "/stats.json",function(data){
						$scope.$apply(function(){
							$scope.uptime = JSON.parse(data).time;
							$scope.aok = true;
						});
					});
				} 
				
				$scope.updateNow = function(){
					$scope.update();
					$scope.nextResponse = $scope.updateRate;
				}
				
				$scope.pumpOn = function(){
					$.post($scope.ip + '/pump/on',{},function(){
						$.get($scope.ip + "/pump.json",function(data){
							$scope.$apply(function(){
								$scope.pump = JSON.parse(data);
							});
						});
					});
				}
				
				$scope.pumpOff = function(){
					$.post($scope.ip + '/pump/off',{},function(){
						$.get($scope.ip + "/pump.json",function(data){
							$scope.$apply(function(){
								$scope.pump = JSON.parse(data);
							});
						});
					});
				}
							
				$scope.dataPoints = 50;
				$scope.updateRate = 5;
				$scope.ip = "http://192.168.2.4";
				$scope.update();

				$scope.nextResponse = $scope.updateRate;
				window.setInterval(function(){
					$scope.$apply(function(){
						$scope.nextResponse -= 1;
						if($scope.nextResponse < 1){
							$scope.updateNow();
						}
					});
				},1000);
			}
		</script>
		
		
	</head>
	<body class="container-fluid" style="padding-top:21px;">
		<div class="row-fluid">
			<div class="span12">
				<h2>Panel sterownika CWU <small><em>v 0.1</em></small></h2>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span12 well">
				<div id="graph" style="height:300px;"></canvas>
			</div>
			<br/>
		</div>
		<div ng-view></div>
	</body>
	<script>
		window.lines = [
			{label: "tCO", data: [], lines:{show:true},points:{show:true}},
			{label: "tCWU1", data: [], lines:{show:true},points:{show:true}},
			{label: "tCWU2", data: [], lines:{show:true},points:{show:true}},
                        {label: "tSpaliny", data: [], lines:{show:true},points:{show:true}},
                        {label: "wentylator", data: [], lines:{show:true},points:{show:true}},
		];
	
		$(function () {
		    var options = {
		        series: { shadowSize: 1 }, // drawing is faster without shadows
		        xaxis: { show: true, mode: "time"},
				yaxis: { tickFormatter: function(val){ return val + " &deg;C"}}
		    };
		    window.plot = $.plot($("#graph"), window.lines, options);

		    window.updateGraph = function() {
		        window.plot.setData(window.lines);
				window.plot.setupGrid();
		        window.plot.draw();
		    }
		
			$(window).bind("resize",function(){
				window.plot.resize();
				window.plot.setupGrid();
                                window.plot.draw();
			});
		
		});
	</script>
</html>